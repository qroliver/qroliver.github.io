name: Update Visitor Count

on:
  workflow_dispatch:  # Manually triggered for testing

jobs:
  update-count:
    runs-on: ubuntu-latest
    steps:
      - name: Install Google Cloud SDK
        run: |
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get install apt-transport-https ca-certificates gnupg
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
          sudo apt-get update && sudo apt-get install google-cloud-sdk -y

      - name: Authenticate with Google Cloud
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        run: |
          gcloud auth application-default print-access-token | head -c -1 > /tmp/token.txt

      - name: Update visitor count on Google Sheets
        env:
          SHEET_ID: "1bc7xQZWl6tJk95itFH-DolvKmDVxJIexNe2JXY4740w" 
        run: |
          TOKEN=$(cat /tmp/token.txt)
          curl -X POST "https://sheets.googleapis.com/v4/spreadsheets/$SHEET_ID/values/Sheet1!A2:append?valueInputOption=USER_ENTERED" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"values":[["New Visitor", "'$(date +%Y-%m-%d)'"]]}'
